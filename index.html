<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Angular Universal Rendering</title></head><body><article><section><div class="meetup"></div><br /><h2>Angular Universal</h2></section><section><div class="avatar"></div></section><section data-bespoke-backdrop="vienna"><h2>Remote Web Dev <br /><br /> Vienna</h2></section><section><h2>Angular & Drupal</h2></section><section><h3>Github : https://github.com/joaogarin</h3><h3>Twitter : https://twitter.com/joaogarin</h3><h3>Linkedin : https://www.linkedin.com/in/joao-garin-9b118525</h3></section><section data-bespoke-backdrop="static universal"><h1>Universal</h1></section><section><h1>Context</h1></section><section><h2>Server Rendered apps</h2></section><section><code><pre>&lt;body&gt;
  <em>
  ...
  &lt;div class=&quot;page-title&quot;&gt;
    &lt;h1&gt;Rendered on the server&lt;/h1&gt;
    &lt;div&gt;
      &lt;p&gt;Welcome home&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  ...
  </em>
  &lt;script src=&quot;my-app.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
</pre></code></section><section><ul class="no-bullets"><li>Server controls the process</li><li>Fetch CSS</li><li>Fetch some fonts</li><li>No javascript needed to render</li></ul></section><section><h2>Single page apps</h2></section><section><code><pre>&lt;body&gt;
  <em>
  &lt;app&gt;&lt;/app&gt;
  </em>
  &lt;script src=&quot;my-app.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
</pre></code></section><section><ul class="no-bullets"><li>Client controls the process</li><li>Javascript does the rendering</li><li>Slower startup time</li><li>Snappier on page transitions after first load</li><li>Requests to already loaded assets dont need to be remade</li></ul></section><section><h2>Taking a step back</h2><h3>&mdash; but... &mdash;</h3><h2>why?</h2></section><section><h1>1 - Search Engine Optimization</h1></section><section><h2>Metatags</h2></section><section><ul class="no-bullets"><li>Title</li><li>Meta description</li><li>Canonical Url's</li><li>Content</li></ul></section><section><h2>Crawlers <br /><br />care about content</h2></section><section><h2>Javascript parsing</h2></section><section><h2>There are solutions</h2><h3>&mdash; but &mdash;</h3><h2>not perfect</h2></section><section><h1>2 - Social media</h1></section><section><h2>Scrapers</h2></section><section data-bespoke-backdrop="static contain social-ng1"></section><section><h2>Specific Protocols</h2></section><section><h2>Twitter <br /><br /></h2><code><pre>...
&lt;meta name=&quot;twitter:card&quot; content=&quot;summary&quot; /&gt;
<em>&lt;meta name=&quot;twitter:site&quot; content=&quot;@nytimesbits&quot; /&gt;</em>
&lt;meta name=&quot;twitter:creator&quot; content=&quot;@nickbilton&quot; /&gt;
...
</pre></code></section><section><h1>3 - User experience</h1></section><section><h2>Startup time</h2></section><section><ul class="no-bullets"><li>Large bundles</li><li>Initial loading time</li><li>Time to first interaction</li></ul></section><section><div class="loading"></div><h3>Loading...</h3></section><section><h3>&ldquo;53% of people will abandon a site if it takes <br />more than 3 sec to load&rdquo;</h3></section><section><h3>&ldquo;Average time to load a website in 3G is ~19sec.&rdquo;</h3></section><section><div class="angular"></div><br /><h2>Angular is fast</h2></section><section><ul class="no-bullets"><li>Optimizatized for performance</li><li>AOT</li><li>Lazy loading</li></ul></section><section><h3>&mdash; there is room for improvement &mdash;</h3></section><section><h2>HTML load</h2><h3>&mdash; to &mdash;</h3><h2>Angular bootstrap</h2></section><section><h2>Important metrics</h2><br/><ul class="no-bullets"><li>Time to meaningful paint</li><li>Time to interactive</li></ul></section><section data-bespoke-backdrop="static contain html-load"></section><section><h2>Lets talk numbers</h2></section><section data-bespoke-backdrop="static contain angular2-todo"></section><section><h2>>4 seconds?</h2><h3>ouch...</h3></section><section data-bespoke-backdrop="static contain angular2-todo-ssr"></section><section><h2>490ms</h2><h3>üëç </h3></section><section><h1>How?</h1></section><section><h2>App that works</h2><h3>&mdash; on &mdash;</h3><h2>Server and client</h2></section><section><h3>&mdash; Good for &mdash; <br /><br /></h3><ul class="no-bullets"><li>UX - Response from the server contains content for our users</li><li>SEO - crawlers can understand our page easily</li><li>Social Media - pages are fully shareable</li></ul></section><section><h3>&mdash; introducing &mdash;</h3><h2>Universal rendering</h2></section><section><h3>Universal rendering or Universal javascript is a concept<br /> or an architectural pattern that consists on using one single version <br /> of our app on multiple environments.</h3></section><section><h3>Allows you to<br /><br /></h3><ul class="no-bullets"><li>Write your code once (one app only)</li><li>Run the app on the client and server (the same app)</li></ul></section><section><h3>what we get with this is<br /> <br /></h3><ul class="no-bullets"><li>Better performance</li><li>SEO compliance</li><li>Social media / Meta information support</li></ul></section><section data-bespoke-backdrop="static universal"><h1>Angular Universal</h1></section><section><div class="contributors"></div><br /><h3>bring server side rendering to Angular with the<br /> least amount of changes to the code a developer has to make.</h3></section><section data-bespoke-backdrop="static contain angular-layers"></section><section><h2>Initial effort</h2><br /><h3>provide everything needed to have angular running on the server</h3></section><section><h2>4.x</h2><h3>Universal moved to Angular core</h3><h3>Open source project provides several wrappers<br/> for different environments</h3></section><section><ul class="no-bullets"><li>Node - Express</li><li>Node - Happyjs</li><li>.Net (in development)</li><li>Java (in development)</li><li>PHP (in development)</li></ul></section><section><h2>Platform-server</h2></section><section><code class="long-pre"><pre>import { readFileSync } from 'fs';
<em>import { renderModuleFactory } from '@angular/platform-server';</em>
import { AppServerModuleFactory } from ‚Äò./app.server.module.ngFactory';

<em>renderModuleFactory(AppServerModuleFactory, {</em>
  document: readFileSync('index.html', 'utf-8'),
  url: '/'
})
.then(html => console.log(html));
</pre></code></section><section><h2>Angular universal <br /><br />with node</h2><h3>&mdash; Express &mdash;</h3></section><section><h2>Before</h2><br/><h3>AppRoot module imports BrowserModule</h3></section><section><h3>app.module.ts<br/><br/></h3><code class="long-pre"><pre>import { NgModule } from '@angular/core';
<em>import { BrowserModule } from '@angular/platform-browser';</em>
import { AppComponent } from './app.component';

@NgModule({
  <em>imports: [ BrowserModule ],</em>
  declarations: [ AppComponent ],
  bootstrap: [ AppComponent ]
})
export class AppModule { }
</pre></code></section><section><h2>After</h2><br/><h3>Two entries - Server & Browser</h3></section><section><h2>Browser</h2><h3>Imports AppModule</h3></section><section><h3>browser-app.module.ts<br/><br/></h3><code class="long-pre"><pre>import { NgModule } from '@angular/core';
<em>import { BrowserModule } from '@angular/platform-browser';</em>
import { AppModule } from './app.module';

@NgModule({
  <em>bootstrap: [ AppComponent ],
    imports: [ 
    BrowserModule.withServerTransition({
      appId: 'my-app-id'
    }),
    AppModule,
  ],</em>
})
export class BrowserAppModule { }
</pre></code></section><section><h2>Server</h2><h3>New NgModule - ServerModule</h3></section><section><h3>server-app.module.ts<br/></h3><code class="long-pre"><pre>import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
<em>import { ServerModule } from '@angular/platform-server';</em>
import { AppModule } from './app.module';

@NgModule({
  bootstrap: [ AppComponent ],
  imports: [ 
    BrowserModule.withServerTransition({
      appId: 'my-app-id'
    }),
    <em>ServerModule,</em>,
    AppModule,
  ],
})
export class ServerAppModule { }
</pre></code></section><section><h2>ServerModule</h2><br ><ul class="no-bullets"><li>Server implementations for some modules like http, location, DOM</li><li>Ensure the same prefix in server and browser</li><li>In the future might provide ways to share state from server to client</li></ul></section><section><h2>Bootstrap</h2><h3>Using express wrapper provided by <br/> @nguniversal/express-engine</h3></section><section><code class="very-long-pre"><pre>...
import * as express from 'express';
<em>import { ServerAppModule } from './app/server-app.module';</em>
<em>import { ngExpressEngine } from '@nguniversal/express-engine';</em>
...
const app = express();
const port = 8000;
const baseUrl = `http://localhost:${port}`;

<em>app.engine('html', ngExpressEngine({
  bootstrap: ServerAppModule
}));</em>

app.set('view engine', 'html');
app.set('views', 'src');
app.use('/', express.static('dist', {index: false}));
...
app.listen(8000,() => {
  console.log(`Listening at ${baseUrl}`);
});
</pre></code></section><section><h2>How it works</h2></section><section><h3>"The pre-rendered page is just static HTML and CSS"</h3></section><section><ol class="no-bullets"><li>Server renderes the app transforming it into a string</li><li>Server provides a static rendered version of that DOM</li><li>Client bootstraps</li><li>Client swaps the server rendered version with the browser version</li></ol></section><section><h1>Universal gotchas</h1></section><section><h2>DOM</h2><h3><strike>Window</strike>, <strike>document</strike>, <strike>navigator</strike></h3></section><section><code class="long-pre"><pre>import { PLATFORM_ID } from '@angular/core';
import { isPlatformBrowser, isPlatformServer } from '@angular/common';

constructor(@Inject(PLATFORM_ID) private platformId: Object) { ... }

ngOnInit() {
  <em>if (isPlatformBrowser(this.platformId)) {
      // Client only code.
      ...
  }
  if (isPlatformServer(this.platformId)) {
    // Server only code.
    ...
  }</em>
}
</pre></code></section><section><h2>Renderer</h2></section><section><h3>DOM API</h3><code class="very-long-pre"><pre>import { Component, ViewChild, ElementRef } from '@angular/core';

@Component({
  selector: 'app-root',
  template: '&lt;input type=&quot;text&quot; #name&gt;'
})
export class AppComponent {
  @ViewChild("name") name: ElementRef;
  
  ngAfterViewInit() {
    this.name.nativeElement.setAttribute('placeholder','Name');
  }
}
</pre></code></section><section><h3>Renderer API</h3><code class="very-long-pre"><pre>import { Component, ViewChild, ElementRef, Renderer2 } from '@angular/core';

@Component({
  selector: 'app-root',
  template: '&lt;input type=&quot;text&quot; #name&gt;'
})
export class AppComponent {
  @ViewChild("name") name: ElementRef;
  
  constructor(private renderer: Renderer2) {}

  ngAfterViewInit() {
    <em>this.renderer.setAttribute(this.name.nativeElement, 'placeholder', 'Name');</em>
  }
}
</pre></code></section><section><h2>Dependencies</h2><h3>Platform specific dependencies</h3></section><section><h3>browser-app.module.ts</h3><code class="long-pre"><pre>@NgModule({
  bootstrap: [AppComponent],
  imports: [
    BrowserModule.withServerTransition({
      appId: 'spotshot'
    }),
    AppModule,
  ],
  providers: [
    <em>{ provide: Storage, useClass: LocalStorage },</em>
  ],
})
export class BrowserAppModule { }
</pre></code></section><section><h3>server-app.module.ts</h3><code class="long-pre"><pre>@NgModule({
  bootstrap: [AppComponent],
  imports: [
    BrowserModule.withServerTransition({
      appId: 'spotshot'
    }),
    ServerModule,
    AppModule,
  ],
  providers: [
    <em>{ provide: Storage, useClass: InMemoryStorage },</em>
  ],
})
export class ServerAppModule { }
</pre></code></section><section><h3>app.component.ts</h3><code class="long-pre"><pre><em>constructor(public storage: Storage)</em>
</pre></code></section><section><h3>storage.ts</h3><code class="very-long-pre"><pre>import {Injectable} from '@angular/core';

export abstract class Storage {
  abstract getItem(key: string): string;
  abstract setItem(key: string, value: string): void;
}

@Injectable()
<em>export class LocalStorage implements Storage</em> {
  ...
}

@Injectable()
<em>export class InMemoryStorage implements Storage</em> {
  ...
}
</pre></code></section><section><h2>Set Timeout</h2><h3>Avoid using it, as it slows down the server response</h3></section><section><h2>Http</h2><h3>By default XHR requests will be made on the server and repeated on the client.</h3></section><section><h1>Angular CLI</h1><h3>Coming soon</h3></section><section><h3>Resources</h3><ul class="no-bullets"><li>https://github.com/FrozenPandaz/ng-universal-demo</li><li>https://github.com/angular/universal</li><li>https://gitter.im/angular/universal</li><li>https://angular.io/docs/ts/latest/guide/universal.html</li></ul></section><section><h2>Thank you!</h2></section></article><script src="index.js"></script></body></html>